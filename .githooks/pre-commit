#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"
API_DIR="$ROOT/services/api"
WEB_DIR="$ROOT/services/web"

# Staged files only
STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACMR)"

api_files=()
web_files=()

while IFS= read -r file; do
  [[ -z "$file" ]] && continue
  [[ "$file" == services/api/* ]] && api_files+=("$file")
  [[ "$file" == services/web/* ]] && web_files+=("$file")
done <<< "$STAGED_FILES"

# API checks
if [[ ${#api_files[@]} -gt 0 ]]; then
  echo "[pre-commit] API formatting checks..."

  if [[ ! -x "$API_DIR/vendor/bin/pint" ]]; then
    echo "[pre-commit] Pint not installed. Run:"
    echo "  cd services/api && composer install"
    exit 1
  fi

  (
    cd "$API_DIR"
    ./vendor/bin/pint --test
  ) || {
    echo "[pre-commit] Pint failed."
    echo "Fix with:"
    echo "  cd services/api && ./vendor/bin/pint"
    exit 1
  }
fi

# Web checks
if [[ ${#web_files[@]} -gt 0 ]]; then
  echo "[pre-commit] Web formatting checks..."

  if [[ ! -d "$WEB_DIR/node_modules" ]]; then
    echo "[pre-commit] node_modules missing. Run:"
    echo "  cd services/web && npm install"
    exit 1
  fi

  (
    cd "$WEB_DIR"
    npm run lint
    npm run format:check
  ) || {
    echo "[pre-commit] Web formatting failed."
    echo "Fix with:"
    echo "  cd services/web && npm run format"
    exit 1
  }
fi

echo "[pre-commit] All checks passed"
